---
title: "Numbers Needed for Change"
author: "Stefan Gruijters & Gjalt-Jorn Ygram Peters"
date: "`r format(Sys.time(), '%Y-%m-%d at %X');`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE);

######################################################################
### Set base path
######################################################################

basePathVector <- c("B:/Data/Research/Numbers Needed for Change (NNC)/ncc (git)",
                    "");

######################################################################
### Set the path variables
######################################################################

### Check which paths exist and set first existing path as base path
basePath <- basePathVector[sapply(basePathVector, dir.exists)][1];

### Set other directories for importing data etc
workingPath <- basePath;
outputPath <- basePath;

######################################################################
### Require packages
######################################################################

require(userfriendlyscience);
safeRequire('ggplot2');
safeRequire('grid');
safeRequire('gridExtra');

######################################################################
### Set parameters
######################################################################

d.categories <- c(.1, .2, .5, .8, 1, 2);
d.from <- .001;
d.to <- 1.5;
cer <- c(.1, .2, .3, .4, .5, .6, .7, .8, .9);
cer.from <- .00001;
cer.to <- .99;

d <- seq(from=d.from, to = d.to, by=.01);

cer.continuous <- seq(cer.from, cer.to, by = .001);

nnc1 <- unlist(lapply(cer, function (currentCer) {
  return(unlist(lapply(d, convert.d.to.nnc, cer=currentCer)));
}));

nnc2 <- unlist(lapply(d.categories, function (currentD) {
  return(unlist(lapply(cer.continuous, convert.d.to.nnc, d=currentD)));
}));

```

## The effect of control event rate (base rate) on the association between Cohen's d and NNC

```{r fig.width=12, fig.height=8}

df1 <- data.frame(d = rep(d, length(cer)),
                 nnc = nnc1,
                 cer = factor(rep(cer, each=length(d))));

ggplot(df1, aes(x=d, y=nnc, group=cer, color=cer)) +
  geom_line(size=1.5) +
  scale_color_brewer(type='qual', palette=3) +
  scale_x_continuous(breaks=c(0, .2, .4, .6, .8, 1, 1.2, 1.4)) +
  coord_cartesian(xlim=c(0.066, 1.4), ylim=c(2.3, 50)) +
  xlab("Cohen's d") + ylab("Numbers Needed for Change") +
  guides( color = guide_legend(title = "CER")) +
  theme_bw(base_size = 22);

ggsave(file.path(outputPath, "figure 1 - cer, d & nnc.png"), 
       width = 14,
       height = 8,
       type='cairo-png');

```

## The association between control event rate (base rate) and NNC for different values of Cohen's d

```{r fig.width=12, fig.height=8}

df2 <- data.frame(d = factor(rep(d.categories, each=length(cer.continuous))),
                 nnc = nnc2,
                 cer = rep(cer.continuous, length(d.categories)));

ggplot(df2, aes(x=cer, y=nnc, group=d, color=d)) +
  geom_line(size=1.5) +
  scale_color_brewer(type='qual', palette=3, direction=-1) +
  scale_x_continuous(breaks=c(0, .2, .4, .6, .8, 1, 1.2, 1.4)) +
  coord_cartesian(xlim=c(0, 1), ylim=c(2.3, 50)) +
  xlab("Control Event Rate") + ylab("Numbers Needed for Change") +
  guides(color = guide_legend(title = "d")) +
  theme_bw(base_size = 22);

ggsave(file.path(outputPath, "figure 2 - d, cer & nnc.png"), 
       width = 14,
       height = 8,
       type='cairo-png');

```

## Illustrations of the CER and EER

```{r fig.width=12, fig.height=8}

# plot1 <- ggNNC(erDataSeq(er=.2, meanValue=3.5, sd=1), d=.5);
# plot2 <- ggNNC(erDataSeq(er=.5, meanValue=3.5, sd=1), d=.5);
# plot3 <- ggNNC(erDataSeq(er=.8, meanValue=3.5, sd=1), d=.5);

plot1 <- ggNNC(erDataSeq(erValue=125, meanValue=90, sd=30), d=.5);
plot2 <- ggNNC(erDataSeq(erValue=135, meanValue=90, sd=30), d=.5);
plot3 <- ggNNC(erDataSeq(erValue=145, meanValue=90, sd=30), d=.5);

Figure4 <- grid.arrange(plot1, plot2, plot3, ncol=3);

ggsave(file.path(outputPath, "figure 4 - cer illustrations.png"),
       plot=Figure4,
       width = 15,
       height = 5,
       type='cairo-png');

```
